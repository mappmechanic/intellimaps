angular.module('intellimap')

.controller('MapCtrl',['$scope','$ionicPlatform','$cordovaGeolocation','DataCollectionService','$http',
function($scope,$ionicPlatform,$cordovaGeolocation,DataCollectionService, $http) {
	$ionicPlatform.ready(function(){
		//DataCollectionService.initCollection();
		var options = {timeout: 10000, enableHighAccuracy: true, maxAge: 0};
	    var geoLocationWatch,bumpMarkers = [];
		$scope.path = [];
		var mapOptions = {
		  zoom: 18,
		  disableDefaultUI: true,
		  mapTypeId: google.maps.MapTypeId.ROADMAP
		};
		$scope.map = new google.maps.Map(document.getElementById("map"), mapOptions);

		var marker = new google.maps.Marker({
			map: $scope.map,
			animation: google.maps.Animation.DROP,
			icon: '/img/marker.png',
			draggable: false
		});

		var radius = new google.maps.Circle({
		  map: $scope.map,
		  radius: 150,
		  strokeColor: '#005ef9',
		  strokeOpacity: 0.5,
		  strokeWeight: 1,
		  fillColor: '#4285f4',
		  fillOpacity: 0.2,
		});
		radius.bindTo('center', marker, 'position');

	        geoLocationWatch = $cordovaGeolocation.watchPosition(options);

	        geoLocationWatch.then(null,function(error) {
	            alert('Please check your connection');
	          },
	          function(position) {
				  clearBumps();
	              circle = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
				  $scope.map.panTo(circle);
				  marker.setPosition(circle);
				  var bumps = $http({
				    url: 'http://44c3538e.ngrok.io/intelliMaps/bumps?latitude='+position.coords.latitude+'&longitude='+position.coords.longitude,
				    method: "GET",
				  })
				  .then(function(resp){
					  console.log("hello:",resp);
					  bumps = resp.data;
					  if(bumps && bumps.length > 0){
						 for(var i = 0; i < bumps.length; i++){
							 bumpMarkers.push(generateBumpMarker(bumps[i].latitude,bumps[i].longitude));
						 }
					  }
				  },function(error){
					  console.log("error:",JSON.stringify(error));
				  });
				  /*var bumps = getCurrentBumps(position.coords.latitude, position.coords.longitude);
				  if(bumps && bumps.length > 0){
					 for(var i = 0; i < bumps.length; i++){
						 bumpMarkers.push(generateBumpMarker(bumps[i].lat,bumps[i].lng));
					 }
				 }*/

			});

		function getCurrentBumps(lat, lng){
			return [{"lat":12.9338919,"lng":77.6948938},{"lat":12.9338919,"lng":77.6948938},{"lat":12.9338919,"lng":77.6948938},{"lat":12.933897,"lng":77.694898},{"lat":12.933897,"lng":77.694898},{"lat":12.933897,"lng":77.694898},{"lat":12.933897,"lng":77.694898},{"lat":12.933897,"lng":77.694898},{"lat":12.933897,"lng":77.694898},{"lat":12.933897,"lng":77.694898},{"lat":12.933897,"lng":77.694898},{"lat":12.9339026,"lng":77.6949017},{"lat":12.9339026,"lng":77.6949017},{"lat":12.9339026,"lng":77.6949017},{"lat":12.9351322,"lng":77.6950136},{"lat":12.9352969,"lng":77.6950166},{"lat":12.9354177,"lng":77.6950097},{"lat":12.9354177,"lng":77.6950097},{"lat":12.9354177,"lng":77.6950097},{"lat":12.9354177,"lng":77.6950097},{"lat":12.9354177,"lng":77.6950097},{"lat":12.9354177,"lng":77.6950097},{"lat":12.935507,"lng":77.6950106},{"lat":12.9363212,"lng":77.6950092},{"lat":12.9363212,"lng":77.6950092},{"lat":12.9363263,"lng":77.6950002},{"lat":12.9363263,"lng":77.6950002},{"lat":12.9363263,"lng":77.6950002},{"lat":12.9365424,"lng":77.6945232},{"lat":12.9365637,"lng":77.6943445},{"lat":12.9365637,"lng":77.6943445},{"lat":12.9365637,"lng":77.6943445},{"lat":12.9365704,"lng":77.6943325},{"lat":12.9366129,"lng":77.694158},{"lat":12.9366129,"lng":77.694158},{"lat":12.9366129,"lng":77.694158},{"lat":12.9366667,"lng":77.6936968},{"lat":12.9366667,"lng":77.6936968},{"lat":12.9366667,"lng":77.6936968},{"lat":12.9366667,"lng":77.6936968},{"lat":12.9366706,"lng":77.6935918},{"lat":12.9365875,"lng":77.6934594},{"lat":12.9365875,"lng":77.6934594},{"lat":12.9365875,"lng":77.6934594},{"lat":12.9365875,"lng":77.6934594},{"lat":12.9365685,"lng":77.693422},{"lat":12.9365685,"lng":77.693422},{"lat":12.9364708,"lng":77.6926673},{"lat":12.9364708,"lng":77.6926673},{"lat":12.9364827,"lng":77.6926375},{"lat":12.9364827,"lng":77.6926375},{"lat":12.9364827,"lng":77.6926375},{"lat":12.9360789,"lng":77.6920915},{"lat":12.9360476,"lng":77.6920467},{"lat":12.9360476,"lng":77.6920467},{"lat":12.936018,"lng":77.6920075},{"lat":12.936018,"lng":77.6920075},{"lat":12.936018,"lng":77.6920075},{"lat":12.9358955,"lng":77.6918831},{"lat":12.9358955,"lng":77.6918831},{"lat":12.9356776,"lng":77.6916524},{"lat":12.9356776,"lng":77.6916524},{"lat":12.9356776,"lng":77.6916524},{"lat":12.9356776,"lng":77.6916524},{"lat":12.9354082,"lng":77.6914032},{"lat":12.9353605,"lng":77.6913446},{"lat":12.9353605,"lng":77.6913446},{"lat":12.9353605,"lng":77.6913446},{"lat":12.9353605,"lng":77.6913446},{"lat":12.9350904,"lng":77.6910334},{"lat":12.9349445,"lng":77.6908697},{"lat":12.9349036,"lng":77.690813},{"lat":12.9349036,"lng":77.690813},{"lat":12.9349036,"lng":77.690813},{"lat":12.9349036,"lng":77.690813},{"lat":12.9348109,"lng":77.6907111},{"lat":12.9347683,"lng":77.6906645},{"lat":12.9347683,"lng":77.6906645},{"lat":12.9347683,"lng":77.6906645},{"lat":12.9347683,"lng":77.6906645},{"lat":12.9347357,"lng":77.6906212},{"lat":12.9347357,"lng":77.6906212},{"lat":12.9346348,"lng":77.6905222},{"lat":12.9346348,"lng":77.6905222},{"lat":12.9346348,"lng":77.6905222},{"lat":12.9346084,"lng":77.6904905},{"lat":12.9346084,"lng":77.6904905},{"lat":12.9346084,"lng":77.6904905},{"lat":12.9346084,"lng":77.6904905},{"lat":12.9345847,"lng":77.6904602},{"lat":12.9345847,"lng":77.6904602},{"lat":12.9345847,"lng":77.6904602},{"lat":12.9345523,"lng":77.6904364},{"lat":12.9345523,"lng":77.6904364},{"lat":12.9345523,"lng":77.6904364},{"lat":12.9345287,"lng":77.6903995},{"lat":12.9345287,"lng":77.6903995},{"lat":12.9345287,"lng":77.6903995},{"lat":12.9345015,"lng":77.6903628},{"lat":12.9345015,"lng":77.6903628},{"lat":12.9345015,"lng":77.6903628},{"lat":12.9345015,"lng":77.6903628},{"lat":12.9344632,"lng":77.6903404},{"lat":12.9344632,"lng":77.6903404},{"lat":12.9344632,"lng":77.6903404},{"lat":12.9344304,"lng":77.6903031},{"lat":12.9344304,"lng":77.6903031},{"lat":12.9342734,"lng":77.6901506},{"lat":12.9342734,"lng":77.6901506},{"lat":12.933686,"lng":77.6895435},{"lat":12.9334205,"lng":77.6892547},{"lat":12.9333854,"lng":77.6892144},{"lat":12.9333491,"lng":77.6891749},{"lat":12.9333491,"lng":77.6891749},{"lat":12.9333491,"lng":77.6891749},{"lat":12.9333086,"lng":77.6891231},{"lat":12.9333086,"lng":77.6891231},{"lat":12.9333086,"lng":77.6891231},{"lat":12.9332655,"lng":77.6890721},{"lat":12.9332655,"lng":77.6890721},{"lat":12.9332655,"lng":77.6890721},{"lat":12.9332202,"lng":77.6890137},{"lat":12.9327289,"lng":77.6884617},{"lat":12.9327289,"lng":77.6884617},{"lat":12.9326643,"lng":77.6883885},{"lat":12.9324361,"lng":77.6881367},{"lat":12.9323914,"lng":77.6880801},{"lat":12.9323914,"lng":77.6880801},{"lat":12.9323914,"lng":77.6880801},{"lat":12.9323459,"lng":77.6880384},{"lat":12.9323459,"lng":77.6880384},{"lat":12.9323459,"lng":77.6880384},{"lat":12.9323074,"lng":77.6880003},{"lat":12.9323074,"lng":77.6880003},{"lat":12.9322018,"lng":77.6878886},{"lat":12.9321819,"lng":77.6878717},{"lat":12.9321819,"lng":77.6878717},{"lat":12.9321819,"lng":77.6878717},{"lat":12.9321572,"lng":77.6878503},{"lat":12.9321572,"lng":77.6878503},{"lat":12.9321572,"lng":77.6878503},{"lat":12.9321335,"lng":77.687839},{"lat":12.9321335,"lng":77.687839},{"lat":12.9321335,"lng":77.687839},{"lat":12.9321073,"lng":77.6878127},{"lat":12.9321073,"lng":77.6878127},{"lat":12.9321073,"lng":77.6878127},{"lat":12.9320824,"lng":77.6877846},{"lat":12.9320824,"lng":77.6877846},{"lat":12.9320578,"lng":77.6877515},{"lat":12.9320363,"lng":77.6877258},{"lat":12.9320363,"lng":77.6877258},{"lat":12.9320129,"lng":77.6877016},{"lat":12.931992,"lng":77.6876809},{"lat":12.9300022,"lng":77.6853027},{"lat":12.9300022,"lng":77.6853027},{"lat":12.9307922,"lng":77.6857777},{"lat":12.9308248,"lng":77.6858199},{"lat":12.9308248,"lng":77.6858199},{"lat":12.9308248,"lng":77.6858199},{"lat":12.9308668,"lng":77.6858667},{"lat":12.9308668,"lng":77.6858667},{"lat":12.9312069,"lng":77.6862676},{"lat":12.9312399,"lng":77.6862976},{"lat":12.9312399,"lng":77.6862976},{"lat":12.9312399,"lng":77.6862976},{"lat":12.9314751,"lng":77.6865564},{"lat":12.9322879,"lng":77.687505},{"lat":12.9323415,"lng":77.6875641},{"lat":12.9323415,"lng":77.6875641},{"lat":12.9333531,"lng":77.6887024},{"lat":12.9333531,"lng":77.6887024},{"lat":12.9352916,"lng":77.6907172},{"lat":12.9353153,"lng":77.6907489},{"lat":12.9353153,"lng":77.6907489},{"lat":12.9353384,"lng":77.6907792},{"lat":12.9366028,"lng":77.6922014},{"lat":12.9369263,"lng":77.6925266},{"lat":12.9374441,"lng":77.6930669},{"lat":12.9374736,"lng":77.6931096},{"lat":12.9374736,"lng":77.6931096},{"lat":12.9375084,"lng":77.6931464},{"lat":12.9375471,"lng":77.6931846},{"lat":12.937689,"lng":77.6933206},{"lat":12.9377217,"lng":77.6933503},{"lat":12.9377217,"lng":77.6933503},{"lat":12.9377517,"lng":77.6933843},{"lat":12.9382981,"lng":77.6939834},{"lat":12.9382981,"lng":77.6939834},{"lat":12.9386072,"lng":77.6943319},{"lat":12.9377792,"lng":77.6939061},{"lat":12.9367187,"lng":77.6939398},{"lat":12.9366914,"lng":77.6940007},{"lat":12.9366914,"lng":77.6940007},{"lat":12.9366914,"lng":77.6940007},{"lat":12.9366916,"lng":77.6940738},{"lat":12.9366212,"lng":77.6944977},{"lat":12.936576,"lng":77.6946853},{"lat":12.9355957,"lng":77.695091},{"lat":12.9355222,"lng":77.695089},{"lat":12.9354515,"lng":77.695087},{"lat":12.9353827,"lng":77.6950824},{"lat":12.9353827,"lng":77.6950824},{"lat":12.9349585,"lng":77.6950479},{"lat":12.933685,"lng":77.6949994},{"lat":12.9332658,"lng":77.6948935},{"lat":12.9332513,"lng":77.694867},{"lat":12.9332598,"lng":77.694868},{"lat":12.9332619,"lng":77.6948673},{"lat":12.9332481,"lng":77.6948467},{"lat":12.9332481,"lng":77.6948467},{"lat":12.9332394,"lng":77.6948345},{"lat":12.93318,"lng":77.6947613},{"lat":12.9331531,"lng":77.694602},{"lat":12.9331437,"lng":77.6945108},{"lat":12.9330379,"lng":77.6941484},{"lat":12.9330218,"lng":77.6940894},{"lat":12.932936,"lng":77.6937944},{"lat":12.9328662,"lng":77.693553},{"lat":12.9328287,"lng":77.6934296},{"lat":12.9328287,"lng":77.6934296},{"lat":12.9326892,"lng":77.6929522},{"lat":12.932657,"lng":77.6928341},{"lat":12.933687,"lng":77.6948565},{"lat":12.933687,"lng":77.6948565},{"lat":12.933687,"lng":77.6948565},{"lat":12.933687,"lng":77.6948565},{"lat":12.933687,"lng":77.6948565},{"lat":12.933687,"lng":77.6948565},{"lat":12.933687,"lng":77.6948565},{"lat":12.933687,"lng":77.6948565},{"lat":12.933687,"lng":77.6948565},{"lat":12.933687,"lng":77.6948565},{"lat":12.933687,"lng":77.6948565},{"lat":12.933687,"lng":77.6948565},{"lat":12.933687,"lng":77.6948565},{"lat":12.933687,"lng":77.6948565},{"lat":12.933687,"lng":77.6948565},{"lat":12.933687,"lng":77.6948565},{"lat":12.933687,"lng":77.6948565},{"lat":12.933687,"lng":77.6948565},{"lat":12.933687,"lng":77.6948565},{"lat":12.933687,"lng":77.6948565},{"lat":12.933687,"lng":77.6948565}];
		}

		function clearBumps(){
			for(var i=0;i<bumpMarkers.length;i++){
				bumpMarkers[i].setMap(null);
			}
		}

		function generateBumpMarker(lat,lng){
			var bump = {
		          path: 'M8 48 L60 48 L56 36 L48 30 L20 30 L12 36 Z',
				  scale: 0.3,
				  strokeColor: '#3a3939',
				  strokeOpacity: 0.8,
				  strokeWeight: 2,
				  fillColor: '#6e6e6e',
				  fillOpacity: 0.9,
		    };
			var bumpMarker = new google.maps.Marker({
		          icon: bump,
		          map: $scope.map,
				  animation: google.maps.Animation.DROP,
		  		  draggable: false,
				  position:new google.maps.LatLng(lat,lng)
		    });
			return bumpMarker;
		}
	});
}]);
